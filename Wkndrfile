#

include ECS

Wkndr.nonce {
  Wkndr.client_side { |gl|
    @store = StorageManager.new
    @transformer = TransformerSystem.new(@store)
    @exhaust = ExhaustSystem.new(@store, @particleBitmap, @particleLayer)
    @movement = MovementSystem.new(@store)
    @watch = @store.watch(PositionComponent, RandomColorComponent)
    @last_l = 0

    gl.open_default_view!
  }
}

Wkndr.client_side { |gl|
  gl.update { |global_time, delta_time|
    gl.drawmode {
      gl.twod {
        @transformer.process(global_time, delta_time)
        @exhaust.process(global_time, delta_time)
        @movement.process(global_time, delta_time)

        gl.mousep { |xyl|
          x, y, l = *xyl

          if (l == 1 && @last_l == 0)
            1.times {
              @store.add(
                TagComponent.new("thing"),
                PositionComponent.new(x, y, 0),
                VelocityComponent.new((300.0 * rand) - 150.0, (300.0 * rand) - 150.0, 0),
                #VelocityComponent.new(100, 0, 0),
                #VelocityComponent.from_angle(2.0 * 3.14 * rand).mul(50.0),
                HunterComponent.new,
                SpriteComponent.new,
                TransformComponent.new(0.75),
                RandomColorComponent.new
              )
            }
          end

          @last_l = l
        }

        @watch.each { |e, p, c|
          gl.draw_circle(10.0, p.x, p.y, p.z, *c.color)
        }

        gl.button(15.0, 15.0, 50.0, 20.0, "  #{@store.things.length} #{"%0.2f" % (1.0 / delta_time)} fps  ") {
          @store.reset!
        }
      }
    }
  }
}


Wkndr.server_side { |server|
  server.wsb("/") do |cn, phr|
  end

  server.raw("/status") do |cn, phr|
    "OK\n"
  end
}
